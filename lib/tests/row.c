#include "row.h"
#include <assert.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void test_row_serialization() {
  Row *row = (Row *)malloc(sizeof(Row));
  row->id = 0;
  strcpy(row->username, "whyneet");
  strcpy(row->email, "whyneet@example.com");

  void *buffer = malloc(ROW_SIZE);
  serialize_row(row, buffer);

  uint8_t expected[] = {
      0,   0,   0,  0,   119, 104, 121, 110, 101, 101, 116, 0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   119, 104, 121, 110, 101, 101, 116, 64,
      101, 120, 97, 109, 112, 108, 101, 46,  99,  111, 109, 0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0};

  // assert(memcmp(buffer, &expected, ROW_SIZE) == 0);

  for (int i = 0; i < ROW_SIZE; i++) {
    printf("%d, ", *((uint8_t *)(buffer + i)));
  }

  free(buffer);
  free(row);
}

void test_row_deserialization() {
  uint8_t source[] = {
      0,   0,   0,  0,   119, 104, 121, 110, 101, 101, 116, 0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   119, 104, 121, 110, 101, 101, 116, 64,
      101, 120, 97, 109, 112, 108, 101, 46,  99,  111, 109, 0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,  0,   0,   0,   0,   0};

  Row *row = malloc(sizeof(Row));
  deserialize_row(source, row);

  assert(row->id == 0);
  assert(strcmp(row->username, "whyneet") == 0);
  assert(strcmp(row->email, "whyneet@example.com") == 0);
}

int main() {
  test_row_serialization();

  return 0;
}
